## üìò `01_plpgsql_basics.md`

# –û—Å–Ω–æ–≤—ã PL/pgSQL ‚Äî —Ñ—É–Ω–∫—Ü–∏–∏, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, IF, —Ü–∏–∫–ª—ã

---

## üß≠ –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

* [1. –ß—Ç–æ —Ç–∞–∫–æ–µ PL/pgSQL](#1-—á—Ç–æ-—Ç–∞–∫–æ–µ-plpgsql)
* [2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏](#2-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ñ—É–Ω–∫—Ü–∏–∏)
* [3. –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç](#3-–æ–±—ä—è–≤–ª–µ–Ω–∏–µ-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö-–∏-–∫–æ–Ω—Å—Ç–∞–Ω—Ç)
* [4. –£–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (IF, ELSIF, ELSE)](#4-—É–ø—Ä–∞–≤–ª—è—é—â–∏–µ-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏-if-elsif-else)
* [5. –¶–∏–∫–ª—ã (LOOP, WHILE, FOR)](#5-—Ü–∏–∫–ª—ã-loop-while-for)
* [6. –í–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö (RETURN, RETURN QUERY)](#6-–≤–æ–∑–≤—Ä–∞—Ç-–¥–∞–Ω–Ω—ã—Ö-return-return-query)
* [7. –†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏](#7-—Ä–∞–±–æ—Ç–∞-—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º–∏-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏)
* [8. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞: –æ—Ü–µ–Ω–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞](#8-–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è-–∑–∞–¥–∞—á–∞-–æ—Ü–µ–Ω–∫–∞-—Å—Ç—É–¥–µ–Ω—Ç–∞)
* [9. –ó–∞–¥–∞—á–∏ –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è](#9-–∑–∞–¥–∞—á–∏-–¥–ª—è-—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

---

## 1. –ß—Ç–æ —Ç–∞–∫–æ–µ PL/pgSQL

**PL/pgSQL (Procedural Language/PostgreSQL SQL)** ‚Äî —ç—Ç–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–π —è–∑—ã–∫ –≤ PostgreSQL.
–û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å *—Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã* –∏ *–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É* –≤–Ω—É—Ç—Ä–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

> –ï—Å–ª–∏ SQL ‚Äî —ç—Ç–æ —è–∑—ã–∫ **—á—Ç–æ** –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å,
> —Ç–æ PL/pgSQL ‚Äî —ç—Ç–æ —è–∑—ã–∫ **–∫–∞–∫ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å**.

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:

* –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ –ë–î;
* –∞—É–¥–∏—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π;
* –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π (—Ç—Ä–∏–≥–≥–µ—Ä—ã, —Ä–∞—Å—á—ë—Ç—ã, –ø—Ä–æ–≤–µ—Ä–∫–∏);
* –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫;
* —Ä–∞–±–æ—Ç–∞ —Å —Ü–∏–∫–ª–∞–º–∏ –∏ —É—Å–ª–æ–≤–∏—è–º–∏ –≤–Ω—É—Ç—Ä–∏ SQL.

---

## 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏

–ë–∞–∑–æ–≤—ã–π —à–∞–±–ª–æ–Ω —Ñ—É–Ω–∫—Ü–∏–∏ PL/pgSQL:

```sql
CREATE OR REPLACE FUNCTION function_name(param_name param_type, ...)
RETURNS return_type AS $$
DECLARE
    -- –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
BEGIN
    -- —Ç–µ–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏
    RETURN –∑–Ω–∞—á–µ–Ω–∏–µ;
END;
$$ LANGUAGE plpgsql;
```

–ü—Ä–∏–º–µ—Ä:

```sql
CREATE OR REPLACE FUNCTION say_hello(name TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN '–ü—Ä–∏–≤–µ—Ç, ' || name || '!';
END;
$$ LANGUAGE plpgsql;
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:

```sql
SELECT say_hello('–ê–ª–µ–∫—Å–µ–π');
```

üü¢ –†–µ–∑—É–ª—å—Ç–∞—Ç:

```
–ü—Ä–∏–≤–µ—Ç, –ê–ª–µ–∫—Å–µ–π!
```

---

## 3. –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—é—Ç—Å—è –≤ –±–ª–æ–∫–µ `DECLARE`:

```sql
DECLARE
    total INT := 0;       -- —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
    name TEXT;            -- –±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏—è
    pi CONSTANT NUMERIC := 3.14159;  -- –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞
```

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```sql
CREATE OR REPLACE FUNCTION calc_square(radius NUMERIC)
RETURNS NUMERIC AS $$
DECLARE
    area NUMERIC;
    pi CONSTANT NUMERIC := 3.14159;
BEGIN
    area := pi * radius * radius;
    RETURN area;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. –£–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (IF, ELSIF, ELSE)

PL/pgSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É—Å–ª–æ–≤–∏—è –∫–∞–∫ –≤ —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è:

```sql
IF —É—Å–ª–æ–≤–∏–µ THEN
    ...
ELSIF –¥—Ä—É–≥–æ–µ_—É—Å–ª–æ–≤–∏–µ THEN
    ...
ELSE
    ...
END IF;
```

–ü—Ä–∏–º–µ—Ä:

```sql
CREATE OR REPLACE FUNCTION grade_score(score INT)
RETURNS TEXT AS $$
DECLARE
    grade TEXT;
BEGIN
    IF score >= 90 THEN
        grade := '–û—Ç–ª–∏—á–Ω–æ';
    ELSIF score >= 75 THEN
        grade := '–•–æ—Ä–æ—à–æ';
    ELSIF score >= 60 THEN
        grade := '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ';
    ELSE
        grade := '–ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ';
    END IF;
    RETURN grade;
END;
$$ LANGUAGE plpgsql;
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:

```sql
SELECT grade_score(95);  -- –û—Ç–ª–∏—á–Ω–æ
SELECT grade_score(78);  -- –•–æ—Ä–æ—à–æ
SELECT grade_score(40);  -- –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ
```

---

## 5. –¶–∏–∫–ª—ã (LOOP, WHILE, FOR)

PL/pgSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∏ —Ç–∏–ø–∞ —Ü–∏–∫–ª–æ–≤:

### üåÄ 5.1 LOOP

–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `EXIT`:

```sql
LOOP
    EXIT WHEN total > 100;
    total := total + 10;
END LOOP;
```

---

### üåÄ 5.2 WHILE

```sql
WHILE —É—Å–ª–æ–≤–∏–µ LOOP
    ...
END LOOP;
```

---

### üåÄ 5.3 FOR

```sql
FOR i IN 1..n LOOP
    ...
END LOOP;
```

–ü—Ä–∏–º–µ—Ä:

```sql
CREATE OR REPLACE FUNCTION sum_to_n(n INT)
RETURNS INT AS $$
DECLARE
    total INT := 0;
    i INT;
BEGIN
    FOR i IN 1..n LOOP
        total := total + i;
    END LOOP;
    RETURN total;
END;
$$ LANGUAGE plpgsql;
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:

```sql
SELECT sum_to_n(10);
```

üü¢ –†–µ–∑—É–ª—å—Ç–∞—Ç: `55`

---

## 6. –í–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö (RETURN, RETURN QUERY)

–§—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ (`RETURN`),
–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—É (`RETURN QUERY`):

```sql
CREATE OR REPLACE FUNCTION get_it_department()
RETURNS TABLE(name TEXT, salary NUMERIC) AS $$
BEGIN
    RETURN QUERY
    SELECT name, salary FROM employees WHERE department = 'IT';
END;
$$ LANGUAGE plpgsql;
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:

```sql
SELECT * FROM get_it_department();
```

---

## 7. –†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

PL/pgSQL –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞–±–æ—Ä *–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö*, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø–∏—Å—ã–≤–∞—é—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞.

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è          | –ö–æ–Ω—Ç–µ–∫—Å—Ç | –û–ø–∏—Å–∞–Ω–∏–µ                                  |
| ------------------- | -------- | ----------------------------------------- |
| `current_user`      | –ª—é–±–æ–π    | –∏–º—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è PostgreSQL      |
| `session_user`      | –ª—é–±–æ–π    | –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–µ—Å—Å–∏–∏                   |
| `NEW`               | —Ç—Ä–∏–≥–≥–µ—Ä  | –∑–∞–ø–∏—Å—å –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è                    |
| `OLD`               | —Ç—Ä–∏–≥–≥–µ—Ä  | –∑–∞–ø–∏—Å—å –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è                       |
| `TG_OP`             | —Ç—Ä–∏–≥–≥–µ—Ä  | —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (INSERT / UPDATE / DELETE)   |
| `TG_TABLE_NAME`     | —Ç—Ä–∏–≥–≥–µ—Ä  | –∏–º—è —Ç–∞–±–ª–∏—Ü—ã, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π —Å—Ä–∞–±–æ—Ç–∞–ª —Ç—Ä–∏–≥–≥–µ—Ä  |
| `TG_WHEN`           | —Ç—Ä–∏–≥–≥–µ—Ä  | –º–æ–º–µ–Ω—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (BEFORE / AFTER)      |
| `TG_LEVEL`          | —Ç—Ä–∏–≥–≥–µ—Ä  | —É—Ä–æ–≤–µ–Ω—å (ROW / STATEMENT)                 |
| `FOUND`             | —Ñ—É–Ω–∫—Ü–∏—è  | true, –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª —Å—Ç—Ä–æ–∫–∏ |
| `ROW_COUNT`         | —Ñ—É–Ω–∫—Ü–∏—è  | –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫               |
| `clock_timestamp()` | –ª—é–±–æ–π    | —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –º–æ–º–µ–Ω—Ç –≤—ã–∑–æ–≤–∞             |

> ‚ö° –ü—Ä–∏–º–µ—Ä:
>
> * `NEW.email` ‚Äî –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ –ø–æ—Å–ª–µ UPDATE.
> * `OLD.email` ‚Äî —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–∞ –¥–æ UPDATE.
> * `TG_OP` = `'UPDATE'` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤ —Ç—Ä–∏–≥–≥–µ—Ä–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ.
> * `current_user` –ø–æ–ª–µ–∑–µ–Ω –¥–ª—è –∞—É–¥–∏—Ç–∞: –∫—Ç–æ –≤—ã–ø–æ–ª–Ω—è–ª –æ–ø–µ—Ä–∞—Ü–∏—é.

---

## 8. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞: –æ—Ü–µ–Ω–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞

**–ó–∞–¥–∞—á–∞:**
–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `student_result(name TEXT, score INT)`,
–∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç:

> `<–ò–º—è>: <–æ—Ü–µ–Ω–∫–∞>`
> –≥–¥–µ –æ—Ü–µ–Ω–∫–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –≤ `grade_score`.

**–†–µ—à–µ–Ω–∏–µ:**

```sql
CREATE OR REPLACE FUNCTION student_result(name TEXT, score INT)
RETURNS TEXT AS $$
DECLARE
    grade TEXT;
BEGIN
    grade := grade_score(score);
    RETURN name || ': ' || grade;
END;
$$ LANGUAGE plpgsql;
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```sql
SELECT student_result('–ò–≤–∞–Ω', 87);
```

üü¢ ‚Üí `–ò–≤–∞–Ω: –•–æ—Ä–æ—à–æ`

---

## 9. –ó–∞–¥–∞—á–∏ –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### üß© –£—Ä–æ–≤–µ–Ω—å 1

–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `double_number(n INT)` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ, —É–º–Ω–æ–∂–µ–Ω–Ω–æ–µ –Ω–∞ 2.

### üß© –£—Ä–æ–≤–µ–Ω—å 2

–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `even_or_odd(n INT)` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `"–ß—ë—Ç–Ω–æ–µ"` –∏–ª–∏ `"–ù–µ—á—ë—Ç–Ω–æ–µ"`.

### üß© –£—Ä–æ–≤–µ–Ω—å 3

–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `factorial(n INT)` ‚Äî –≤—ã—á–∏—Å–ª—è–µ—Ç —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª —á–µ—Ä–µ–∑ —Ü–∏–∫–ª `FOR`.

---

## ‚úÖ –°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å

üëâ [02_working_with_tables.md](02_working_with_tables.md)
**"–†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö"**

---
