## üìò `02_working_with_tables.md`

# –†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –≤ PL/pgSQL

---

## üß≠ –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

* [1. –í–≤–µ–¥–µ–Ω–∏–µ: –∑–∞—á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π](#1-–≤–≤–µ–¥–µ–Ω–∏–µ-–∑–∞—á–µ–º-—Ä–∞–±–æ—Ç–∞—Ç—å-—Å-—Ç–∞–±–ª–∏—Ü–∞–º–∏-–≤–Ω—É—Ç—Ä–∏-—Ñ—É–Ω–∫—Ü–∏–π)
* [2. SELECT INTO ‚Äî –≤—ã–±–æ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ](#2-select-into--–≤—ã–±–æ—Ä–∫–∞-–¥–∞–Ω–Ω—ã—Ö-–≤-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
* [3. INSERT, UPDATE, DELETE –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π](#3-insert-update-delete-–≤–Ω—É—Ç—Ä–∏-—Ñ—É–Ω–∫—Ü–∏–π)
* [4. PERFORM ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö](#4-perform--–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ-–±–µ–∑-–≤–æ–∑–≤—Ä–∞—Ç–∞-–¥–∞–Ω–Ω—ã—Ö)
* [5. RETURN QUERY ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞–±–æ—Ä–∞ —Å—Ç—Ä–æ–∫](#5-return-query--–≤–æ–∑–≤—Ä–∞—Ç-–Ω–∞–±–æ—Ä–∞-—Å—Ç—Ä–æ–∫)
* [6. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ FOUND –∏ ROW_COUNT](#6-–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-found-–∏-row_count)
* [7. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞: –ø–æ–≤—ã—à–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç –ø–æ –æ—Ç–¥–µ–ª—É](#7-–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è-–∑–∞–¥–∞—á–∞-–ø–æ–≤—ã—à–µ–Ω–∏–µ-–∑–∞—Ä–ø–ª–∞—Ç-–ø–æ-–æ—Ç–¥–µ–ª—É)
* [8. –ó–∞–¥–∞—á–∏ –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è](#8-–∑–∞–¥–∞—á–∏-–¥–ª—è-—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

---

## 1. –í–≤–µ–¥–µ–Ω–∏–µ: –∑–∞—á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π

PL/pgSQL –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –Ω–∞–ø—Ä—è–º—É—é ‚Äî
–¥–æ–±–∞–≤–ª—è—Ç—å, –∏–∑–º–µ–Ω—è—Ç—å, —É–¥–∞–ª—è—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.

–≠—Ç–æ –Ω—É–∂–Ω–æ, –∫–æ–≥–¥–∞:

* –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø—Ä—è–º–æ –≤ –ë–î;
* —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞—É–¥–∏—Ç –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∫–ª–∏–µ–Ω—Ç–∞;
* –Ω—É–∂–Ω–æ –≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á—ë—Ç—ã –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞.

---

## 2. SELECT INTO ‚Äî –≤—ã–±–æ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

`SELECT INTO` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.

```sql
CREATE OR REPLACE FUNCTION get_salary(emp_name TEXT)
RETURNS NUMERIC AS $$
DECLARE
    emp_salary NUMERIC;
BEGIN
    SELECT salary INTO emp_salary
    FROM employees
    WHERE name = emp_name;

    RETURN emp_salary;
END;
$$ LANGUAGE plpgsql;
```

üß© **–ü–æ—è—Å–Ω–µ–Ω–∏–µ:**

* `INTO emp_salary` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é.
* –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è = `NULL`.
* –ü–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `IF FOUND THEN ...`.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```sql
SELECT get_salary('–ê–Ω–Ω–∞');
SELECT get_salary('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π');
```

---

## 3. INSERT, UPDATE, DELETE –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π

–§—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å —Ç–∞–±–ª–∏—Ü—ã –Ω–∞–ø—Ä—è–º—É—é.

```sql
CREATE OR REPLACE FUNCTION update_email(u_id INT, new_email TEXT)
RETURNS TEXT AS $$
BEGIN
    UPDATE users
    SET email = new_email
    WHERE id = u_id;

    IF FOUND THEN
        RETURN '–ü–æ—á—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞';
    ELSE
        RETURN '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
    END IF;
END;
$$ LANGUAGE plpgsql;
```

üß© **–ü–æ—è—Å–Ω–µ–Ω–∏–µ:**

* `FOUND` ‚Äî —Å–ª—É–∂–µ–±–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è (TRUE, –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Ö–æ—Ç—è –±—ã 1 —Å—Ç—Ä–æ–∫–∞).
* –î–ª—è —Ç–æ—á–Ω–æ–≥–æ —á–∏—Å–ª–∞ —Å—Ç—Ä–æ–∫ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `GET DIAGNOSTICS count = ROW_COUNT;`.

---

## 4. PERFORM ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

–ö–æ–≥–¥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –Ω—É–∂–µ–Ω, –ø—Ä–∏–º–µ–Ω—è—é—Ç `PERFORM`.

```sql
CREATE OR REPLACE FUNCTION delete_empty_emails()
RETURNS VOID AS $$
BEGIN
    PERFORM 1 FROM users WHERE email IS NULL;
    DELETE FROM users WHERE email IS NULL;
END;
$$ LANGUAGE plpgsql;
```

üß© **–ü–æ—è—Å–Ω–µ–Ω–∏–µ:**
`PERFORM` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ `SELECT`, –Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî —É–¥–æ–±–Ω–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–π –±–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞.

---

## 5. RETURN QUERY ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞–±–æ—Ä–∞ —Å—Ç—Ä–æ–∫

–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `RETURN QUERY`.

```sql
CREATE OR REPLACE FUNCTION get_department_employees(dep TEXT)
RETURNS TABLE(id INT, name TEXT, salary NUMERIC) AS $$
BEGIN
    RETURN QUERY
    SELECT id, name, salary
    FROM employees
    WHERE department = dep;
END;
$$ LANGUAGE plpgsql;
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```sql
SELECT * FROM get_department_employees('IT');
```

–ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ `RETURN QUERY` ‚Äî –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—ä–µ–¥–∏–Ω—è—Ç—Å—è.

---

## 6. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ FOUND –∏ ROW_COUNT

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ SQL-–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ PostgreSQL —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ª—É–∂–µ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è        | –û–ø–∏—Å–∞–Ω–∏–µ                                          |
| ----------------- | ------------------------------------------------- |
| `FOUND`           | TRUE, –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –∑–∞—Ç—Ä–æ–Ω—É–ª ‚â• 1 —Å—Ç—Ä–æ–∫—É   |
| `ROW_COUNT`       | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫, –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–Ω–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º |
| `GET DIAGNOSTICS` | –ü–æ–∑–≤–æ–ª—è–µ—Ç —è–≤–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è             |

–ü—Ä–∏–º–µ—Ä:

```sql
CREATE OR REPLACE FUNCTION mark_bonus(dep TEXT)
RETURNS TEXT AS $$
DECLARE
    affected INT;
BEGIN
    UPDATE employees
    SET salary = salary * 1.1
    WHERE department = dep;

    GET DIAGNOSTICS affected = ROW_COUNT;

    RETURN '–ò–∑–º–µ–Ω–µ–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ' || affected;
END;
$$ LANGUAGE plpgsql;
```

---

## 7. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞: –ø–æ–≤—ã—à–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç –ø–æ –æ—Ç–¥–µ–ª—É

**–ó–∞–¥–∞—á–∞:**
–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `increase_salary(dep TEXT, percent NUMERIC)` ‚Äî
—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –æ—Ç–¥–µ–ª–∞ –Ω–∞ `percent %` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫.

```sql
CREATE OR REPLACE FUNCTION increase_salary(dep TEXT, percent NUMERIC)
RETURNS INT AS $$
DECLARE
    updated_count INT;
BEGIN
    UPDATE employees
    SET salary = salary * (1 + percent / 100)
    WHERE department = dep;

    GET DIAGNOSTICS updated_count = ROW_COUNT;

    RETURN updated_count;
END;
$$ LANGUAGE plpgsql;
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```sql
SELECT increase_salary('IT', 10);
SELECT * FROM employees;
```

üü¢ –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å–ª–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫, –∞ –∑–∞—Ä–ø–ª–∞—Ç—ã —Ä–µ–∞–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è.

---

## 8. –ó–∞–¥–∞—á–∏ –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### üß© –£—Ä–æ–≤–µ–Ω—å 1

–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `delete_low_salary(min NUMERIC)` ‚Äî
—É–¥–∞–ª—è–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –∑–∞—Ä–ø–ª–∞—Ç–æ–π –Ω–∏–∂–µ `min` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫.

---

### üß© –£—Ä–æ–≤–µ–Ω—å 2

–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `copy_department(old_dep TEXT, new_dep TEXT)` ‚Äî
–∫–æ–ø–∏—Ä—É–µ—Ç –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –æ–¥–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ –≤ –¥—Ä—É–≥–æ–π (–∏–∑–º–µ–Ω—è—è –ø–æ–ª–µ `department`).

---

### üß© –£—Ä–æ–≤–µ–Ω—å 3

–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `average_salary(dep TEXT)` ‚Äî
–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é –∑–∞—Ä–ø–ª–∞—Ç—É –ø–æ –æ—Ç–¥–µ–ª—É.
–ü–æ–¥—Å–∫–∞–∑–∫–∞: `SELECT AVG(salary) INTO ...`.

---

### üß© –£—Ä–æ–≤–µ–Ω—å 4

–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `employees_report()` ‚Äî
–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `(department, count, avg_salary)`
—á–µ—Ä–µ–∑ `RETURN QUERY` –∏ `GROUP BY`.

---

‚úÖ –ü–æ—Å–ª–µ —ç—Ç–æ–π —á–∞—Å—Ç–∏ —Ç—ã —É–º–µ–µ—à—å:

* —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π;
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SELECT INTO`, `UPDATE`, `DELETE`, `RETURN QUERY`;
* –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `FOUND`, `ROW_COUNT`, `GET DIAGNOSTICS`;
* —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ PostgreSQL.

---

üìò –°–ª–µ–¥—É—é—â–∏–π —Ñ–∞–π–ª ‚Üí [03_triggers_intro.md](03_triggers_intro.md)
**‚Äú–¢—Ä–∏–≥–≥–µ—Ä—ã –≤ PostgreSQL: OLD, NEW, TG_OP, TG_TABLE_NAME –∏ –∞—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π‚Äù**
-----------------------------------------------------------------------------


