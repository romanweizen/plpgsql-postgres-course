
## üìò `00_reset_all.md`

# –ü–æ–ª–Ω—ã–π —Ä–µ—Å–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫—É—Ä—Å–∞: –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã, —Ç–∞–±–ª–∏—Ü –∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üß≠ –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

* [1. –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç](#1-—á—Ç–æ-–¥–µ–ª–∞–µ—Ç-—ç—Ç–æ—Ç-—Å–∫—Ä–∏–ø—Ç)
* [2. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#2-–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
* [3. –ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Ä–µ—Å–µ—Ç–∞ (—Å–∫–æ–ø–∏—Ä—É–π –∏ –≤—ã–ø–æ–ª–Ω–∏ —Ü–µ–ª–∏–∫–æ–º)](#3-–ø–æ–ª–Ω—ã–π-—Å–∫—Ä–∏–ø—Ç-—Ä–µ—Å–µ—Ç–∞-—Å–∫–æ–ø–∏—Ä—É–π-–∏-–≤—ã–ø–æ–ª–Ω–∏-—Ü–µ–ª–∏–∫–æ–º)
* [4. –ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ –ø–æ—Å–ª–µ —Ä–µ—Å–µ—Ç–∞](#4-—á—Ç–æ-—Å–æ–∑–¥–∞–Ω–æ-–ø–æ—Å–ª–µ-—Ä–µ—Å–µ—Ç–∞)
* [5. –°–∞–Ω–∏—Ç–∏-—á–µ–∫–∏ (–±—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)](#5-—Å–∞–Ω–∏—Ç–∏-—á–µ–∫–∏-–±—ã—Å—Ç—Ä—ã–µ-–ø—Ä–æ–≤–µ—Ä–∫–∏)
* [6. –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∏ —Ç–æ–Ω–∫–æ—Å—Ç–∏](#6-–ø—Ä–∏–º–µ—á–∞–Ω–∏—è-–∏-—Ç–æ–Ω–∫–æ—Å—Ç–∏)

---

## 1. –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç

* —Å–æ–∑–¥–∞—ë—Ç (–∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç) **—Å—Ö–µ–º—É `course`** –∏ —Å—Ç–∞–≤–∏—Ç `search_path` ‚Üí `course, public`;
* **—á–∏—Å—Ç–∏—Ç** —Å–ª–µ–¥—ã –ø—Ä–æ—à–ª—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤: —Ç–∞–±–ª–∏—Ü—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã, —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏;
* —Å–æ–∑–¥–∞—ë—Ç **–≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã**, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤–æ –≤—Å—ë–º –∫—É—Ä—Å–µ:

  * `employees`, `users`, `users_history`, `audit_log`,
    `products`, `orders`, `deleted_users`, `events`, `orders_archive`;
* **–∑–∞–ø–æ–ª–Ω—è–µ—Ç** —Ç–∞–±–ª–∏—Ü—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏;
* –¥–æ–±–∞–≤–ª—è–µ—Ç **–ø–æ–ª–µ–∑–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã** (–ø–æ e-mail, username, product –∏ —Ç.–¥.);
* –≥–æ—Ç–æ–≤–∏—Ç —Ç–µ–±—è –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É –∫–æ–¥–æ–≤ –∏–∑ —Ñ–∞–π–ª–æ–≤ `01‚Äì08`.

---

## 2. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –û—Ç–∫—Ä–æ–π DBeaver/psql ‚Üí –≤—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—É—é –ë–î.
2. –°–∫–æ–ø–∏—Ä—É–π **–≤–µ—Å—å** –±–ª–æ–∫ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ ‚Ññ3.
3. –í—ã–ø–æ–ª–Ω–∏ –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º.
4. –ó–∞–ø—É—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ ‚Ññ5 ‚Äî —É–≤–∏–¥–∏—à—å –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.

---

## 3. –ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Ä–µ—Å–µ—Ç–∞ (—Å–∫–æ–ø–∏—Ä—É–π –∏ –≤—ã–ø–æ–ª–Ω–∏ —Ü–µ–ª–∏–∫–æ–º)

```sql
-- ===========================================================
-- PL/pgSQL Course: Full Reset Script
-- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã, —Ç–∞–±–ª–∏—Ü –∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
-- –°–æ–≤–º–µ—Å—Ç–∏–º —Å PostgreSQL 13+
-- ===========================================================

-- 0) –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
SET client_min_messages = WARNING;

-- 1) –°–æ–∑–¥–∞—ë–º —á–∏—Å—Ç—É—é —Å—Ö–µ–º—É –∏ —Å—Ç–∞–≤–∏–º search_path
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_namespace WHERE nspname = 'course'
  ) THEN
    EXECUTE 'CREATE SCHEMA course';
  END IF;
END $$;

SET search_path TO course, public;

-- 2) –£–¥–∞–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–æ—à–ª—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ (–µ—Å–ª–∏ –±—ã–ª–∏)
--    (—á—Ç–æ–±—ã —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –Ω–µ –º–µ—à–∞–ª–∏, –ø–µ—Ä–µ—á–∏—Å–ª—è–µ–º –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –∏–∑ –∫—É—Ä—Å–∞)
DO $cleanup$
BEGIN
  -- –ë–∞–∑–æ–≤—ã–µ PL/pgSQL (–º–æ–≥–ª–∏ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –≤ —É—á–µ–±–Ω—ã—Ö —à–∞–≥–∞—Ö)
  PERFORM 1 FROM pg_proc WHERE proname = 'say_hello';                 IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS say_hello(text) CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'grade_score';               IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS grade_score(integer) CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'sum_to_n';                  IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS sum_to_n(integer) CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'get_salary';                IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS get_salary(text) CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'update_email';              IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS update_email(integer,text) CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'delete_empty_emails';       IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS delete_empty_emails() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'get_department_employees';  IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS get_department_employees(text) CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'mark_bonus';                IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS mark_bonus(text) CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'increase_salary';           IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS increase_salary(text,numeric) CASCADE'; END IF;

  -- –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∞—É–¥–∏—Ç
  PERFORM 1 FROM pg_proc WHERE proname = 'update_timestamp';          IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS update_timestamp() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'log_user_update';           IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS log_user_update() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'audit_changes';             IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS audit_changes() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'audit_changes_verbose';     IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS audit_changes_verbose() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'audit_differences';         IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS audit_differences() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'audit_update_delete';       IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS audit_update_delete() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'refresh_updated_at';        IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS refresh_updated_at() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'calc_total_price';          IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS calc_total_price() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'audit_all';                 IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS audit_all() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'audit_verbose';             IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS audit_verbose() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'get_audit_history';         IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS get_audit_history(text,integer) CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'soft_delete';               IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS soft_delete() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'audit_changed_columns';     IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS audit_changed_columns() CASCADE'; END IF;
  PERFORM 1 FROM pg_proc WHERE proname = 'archive_old_records';       IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS archive_old_records() CASCADE'; END IF;

  -- –î–∏–Ω–∞–º–∏–∫–∞ –∏ –ø—Ä.
  PERFORM 1 FROM pg_proc WHERE proname = 'dynamic_select';            IF FOUND THEN EXECUTE 'DROP FUNCTION IF EXISTS dynamic_select(text) CASCADE'; END IF;
END
$cleanup$ LANGUAGE plpgsql;

-- 3) –°–Ω–æ—Å–∏–º —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å) –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º
DROP TABLE IF EXISTS orders_archive CASCADE;
DROP TABLE IF EXISTS events         CASCADE;
DROP TABLE IF EXISTS deleted_users  CASCADE;
DROP TABLE IF EXISTS orders         CASCADE;
DROP TABLE IF EXISTS products       CASCADE;
DROP TABLE IF EXISTS audit_log      CASCADE;
DROP TABLE IF EXISTS users_history  CASCADE;
DROP TABLE IF EXISTS users          CASCADE;
DROP TABLE IF EXISTS employees      CASCADE;

-- 3.1) employees
CREATE TABLE employees (
    id           INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    name         TEXT NOT NULL,
    salary       NUMERIC(12,2) NOT NULL CHECK (salary >= 0),
    department   TEXT NOT NULL
);

INSERT INTO employees (name, salary, department) VALUES
('–ê–Ω–Ω–∞',   50000, 'HR'),
('–ò–≤–∞–Ω',   80000, 'IT'),
('–ú–∞—Ä–∏—è',  60000, 'Finance'),
('–ü–∞–≤–µ–ª',  90000, 'IT'),
('–û–ª—å–≥–∞',  45000, 'HR'),
('–î–º–∏—Ç—Ä–∏–π',75000, 'Finance');

-- 3.2) users
CREATE TABLE users (
    id          INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    username    TEXT UNIQUE NOT NULL,
    email       TEXT,
    updated_at  TIMESTAMP NOT NULL DEFAULT NOW()
);

INSERT INTO users (username, email) VALUES
('alex',  'alex@mail.ru'),
('maria', 'maria@gmail.com'),
('ivan',  'ivan@yandex.ru'),
('kate',  'kate@corp.com');

UPDATE users SET email = 'alex_new@mail.ru' WHERE username = 'alex';
UPDATE users SET email = LOWER(email) WHERE username IN ('maria', 'ivan');

-- 3.3) users_history
CREATE TABLE users_history (
    id          INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id     INT NOT NULL,
    old_email   TEXT,
    new_email   TEXT,
    changed_at  TIMESTAMP NOT NULL DEFAULT NOW()
);

INSERT INTO users_history (user_id, old_email, new_email, changed_at)
VALUES (1, 'alex@mail.ru', 'alex_new@mail.ru', NOW() - INTERVAL '1 day');

-- 3.4) audit_log
CREATE TABLE audit_log (
    id          INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    table_name  TEXT NOT NULL,
    operation   TEXT NOT NULL,
    old_data    JSONB,
    new_data    JSONB,
    changed_at  TIMESTAMP NOT NULL DEFAULT NOW(),
    user_name   TEXT,
    app_name    TEXT
);

INSERT INTO audit_log (table_name, operation, old_data, new_data, user_name, app_name, changed_at)
VALUES
('users', 'INSERT', NULL, '{"id":10,"username":"test","email":"t@t.t"}', current_user, current_setting('application_name', true), NOW() - INTERVAL '2 days'),
('users', 'UPDATE', '{"id":10,"email":"t@t.t"}', '{"id":10,"email":"t2@t.t"}', current_user, current_setting('application_name', true), NOW() - INTERVAL '1 day'),
('users', 'DELETE', '{"id":10,"username":"test"}', NULL, current_user, current_setting('application_name', true), NOW() - INTERVAL '12 hours');

-- 3.5) products / orders
CREATE TABLE products (
    id     INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    name   TEXT UNIQUE NOT NULL,
    price  NUMERIC(12,2) NOT NULL CHECK (price >= 0)
);

CREATE TABLE orders (
    id           INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    product      TEXT NOT NULL REFERENCES products(name) ON UPDATE CASCADE,
    quantity     INT NOT NULL CHECK (quantity > 0),
    total_price  NUMERIC(14,2),
    updated_at   TIMESTAMP NOT NULL DEFAULT NOW()
);

INSERT INTO products (name, price) VALUES
('Laptop',      120000.00),
('Keyboard',       4500.00),
('Mouse',          2500.00),
('Monitor',       30000.00),
('USB Hub',        1900.00);

INSERT INTO orders (product, quantity) VALUES
('Laptop',  1),
('Mouse',   3),
('Keyboard',2),
('Monitor', 2),
('USB Hub', 4);

UPDATE products SET price = price * 1.05 WHERE name IN ('Laptop','Monitor');

-- 3.6) deleted_users
CREATE TABLE deleted_users (
    id          INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id     INT NOT NULL,
    email       TEXT,
    deleted_at  TIMESTAMP NOT NULL DEFAULT NOW()
);

INSERT INTO deleted_users (user_id, email, deleted_at)
VALUES (3, 'ivan@yandex.ru', NOW() - INTERVAL '6 hours');

-- 3.7) events
CREATE TABLE events (
    id          INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    created_at  TIMESTAMP NOT NULL DEFAULT NOW(),
    data        JSONB NOT NULL
);

INSERT INTO events (created_at, data) VALUES
(NOW() - INTERVAL '2 days',  '{"event":"login","user_id":101,"device":"ios"}'),
(NOW() - INTERVAL '1 day',   '{"event":"click","user_id":101,"button":"buy"}'),
(NOW() - INTERVAL '20 hours','{"event":"login","user_id":202,"device":"android"}'),
(NOW() - INTERVAL '12 hours','{"event":"purchase","user_id":101,"amount":1990.50,"currency":"RUB"}'),
(NOW() - INTERVAL '1 hour',  '{"event":"click","user_id":202,"button":"details"}');

-- 3.8) orders_archive
CREATE TABLE orders_archive (
    id           INT,
    product      TEXT,
    quantity     INT,
    total_price  NUMERIC(14,2),
    updated_at   TIMESTAMP,
    archived_at  TIMESTAMP NOT NULL DEFAULT NOW()
);

INSERT INTO orders_archive (id, product, quantity, total_price, updated_at, archived_at)
SELECT id, product, quantity, total_price, updated_at, NOW() - INTERVAL '1 day'
FROM orders
WHERE id IN (1,2);

-- 4) –ü–æ–ª–µ–∑–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
CREATE INDEX IF NOT EXISTS idx_users_username ON users (username);
CREATE INDEX IF NOT EXISTS idx_users_email    ON users (email);
CREATE INDEX IF NOT EXISTS idx_orders_product ON orders (product);
CREATE INDEX IF NOT EXISTS idx_products_name  ON products (name);
-- JSONB GIN –∏–Ω–¥–µ–∫—Å (–≤–∫–ª—é—á–∏ –ø—Ä–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö JSON-–∑–∞–ø—Ä–æ—Å–∞—Ö)
-- CREATE INDEX IF NOT EXISTS idx_events_data_gin ON events USING gin (data);

-- 5) –§–∏–Ω–∞–ª—å–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
SET application_name = 'course_ready';
RESET client_min_messages;
-- –ì–æ—Ç–æ–≤–æ.
```

---

## 4. –ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ –ø–æ—Å–ª–µ —Ä–µ—Å–µ—Ç–∞

* **–°—Ö–µ–º–∞:** `course` (+ `search_path` –≤—ã—Å—Ç–∞–≤–ª–µ–Ω)
* **–¢–∞–±–ª–∏—Ü—ã:**
  `employees`, `users`, `users_history`, `audit_log`,
  `products`, `orders`, `deleted_users`, `events`, `orders_archive`
* **–î–∞–Ω–Ω—ã–µ:** —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ –Ω–∞–±–æ—Ä—ã, —Å–æ–≥–ª–∞—Å—É—é—â–∏–µ—Å—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ `01‚Äì08`
* **–ò–Ω–¥–µ–∫—Å—ã:** –Ω–∞ —á–∞—Å—Ç—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã; –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π GIN –¥–ª—è JSONB

---

## 5. –°–∞–Ω–∏—Ç–∏-—á–µ–∫–∏ (–±—ã—Å—Ç—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)

–°—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–µ—Å–µ—Ç–∞ ‚Äî –ø—Ä–æ–≥–æ–Ω—è–π:

```sql
-- –°–≤–æ–¥ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
SELECT department, COUNT(*) AS cnt, ROUND(AVG(salary)) AS avg_salary
FROM employees
GROUP BY department
ORDER BY department;

-- –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–ø–æ—Å–ª–µ –∞–ø–¥–µ–π—Ç–æ–≤)
SELECT * FROM users ORDER BY id;

-- –ò—Å—Ç–æ—Ä–∏—è e-mail
SELECT * FROM users_history ORDER BY changed_at DESC;

-- –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏—Ç–∞
SELECT table_name, operation, user_name, app_name, changed_at
FROM audit_log
ORDER BY changed_at DESC;

-- –ó–∞–∫–∞–∑—ã + –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
SELECT o.id, o.product, o.quantity, p.price AS current_price, o.total_price
FROM orders o
JOIN products p ON p.name = o.product
ORDER BY o.id;

-- –ß–∞—Å—Ç–æ—Ç–∞ JSON-—Å–æ–±—ã—Ç–∏–π
SELECT data->>'event' AS event, COUNT(*) AS cnt
FROM events
GROUP BY data->>'event'
ORDER BY cnt DESC;

-- –ê—Ä—Ö–∏–≤ –ø—Ä–æ–≤–µ—Ä–∫–∞
SELECT COUNT(*) AS archived_cnt FROM orders_archive;
```

---

## 6. –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∏ —Ç–æ–Ω–∫–æ—Å—Ç–∏

* –°–∫—Ä–∏–ø—Ç **–Ω–µ** –≤–∫–ª—é—á–∞–µ—Ç —Å–∞–º–∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã/—Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –≥–ª–∞–≤ ‚Äî –æ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `03_triggers_intro.md`, `04_jsonb_audit.md`, `05_practice_and_selfcheck.md`).
* –ï—Å–ª–∏ —Ç—ã —É–∂–µ –Ω–∞–≤–µ—à–∏–≤–∞–ª —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤ –ø—Ä–æ—à–ª—ã—Ö —Å–µ—Å—Å–∏—è—Ö ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —Å `CASCADE` —Å–Ω–∏–º–∞–µ—Ç –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã, –∞ –±–ª–æ–∫ ¬´–æ—á–∏—Å—Ç–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π¬ª —Å–≤–µ—Ä—Ö—É —É–¥–∞–ª—è–µ—Ç —Å–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–∏ (—á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã).
* –î–ª—è —Ä–∞–±–æ—Ç—ã —Å JSONB –Ω–∞ –±–æ–ª—å—à–∏—Ö –º–∞—Å—Å–∏–≤–∞—Ö –¥–∞–Ω–Ω—ã—Ö –≤–∫–ª—é—á–∞–π GIN-–∏–Ω–¥–µ–∫—Å –Ω–∞ `events.data`.
* `SET search_path TO course, public` –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é —Ç–∞–±–ª–∏—Ü—É `course.` –≤–æ –≤—Å–µ—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö.

---

–ì–æ—Ç–æ–≤–æ! –≠—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî —Ç–≤–æ–π ¬´–∫–Ω–æ–ø–∫–∞ —Ä–µ—Å–µ—Ç–∞¬ª.
–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –¥–æ–±–∞–≤–ª—é –º–∏–Ω–∏-—Å–∫—Ä–∏–ø—Ç `Makefile` –∏–ª–∏ `psql -f` –∫–æ–º–∞–Ω–¥—É –≤ README, —á—Ç–æ–±—ã —Ä–µ—Å–µ—Ç –∑–∞–ø—É—Å–∫–∞–ª—Å—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.
