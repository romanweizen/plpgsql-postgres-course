## üìò `04_jsonb_audit.md`

# JSONB-–∞—É–¥–∏—Ç –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ PostgreSQL

---

## üß≠ –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

* [1. –ó–∞—á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSONB –¥–ª—è –∞—É–¥–∏—Ç–∞](#1-–∑–∞—á–µ–º-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å-jsonb-–¥–ª—è-–∞—É–¥–∏—Ç–∞)
* [2. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ JSONB –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –æ–±—ã—á–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏—Å—Ç–æ—Ä–∏–∏](#2-–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞-jsonb-–ø–æ-—Å—Ä–∞–≤–Ω–µ–Ω–∏—é-—Å-–æ–±—ã—á–Ω—ã–º–∏-—Ç–∞–±–ª–∏—Ü–∞–º–∏-–∏—Å—Ç–æ—Ä–∏–∏)
* [3. –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∞—É–¥–∏—Ç–∞](#3-—Å–æ–∑–¥–∞–Ω–∏–µ-—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π-—Ç–∞–±–ª–∏—Ü—ã-–∞—É–¥–∏—Ç–∞)
* [4. –§—É–Ω–∫—Ü–∏—è-—Ç—Ä–∏–≥–≥–µ—Ä audit_changes() ‚Äî –±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è](#4-—Ñ—É–Ω–∫—Ü–∏—è-—Ç—Ä–∏–≥–≥–µ—Ä-audit_changes--–±–∞–∑–æ–≤–∞—è-–≤–µ—Ä—Å–∏—è)
* [5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤—Ä–µ–º—è](#5-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ-–≤—Ä–µ–º—è)
* [6. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª–µ–π](#6-–ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è-–≤–µ—Ä—Å–∏—è--–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ-—Ç–æ–ª—å–∫–æ-–∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö-–ø–æ–ª–µ–π)
* [7. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞: –≥–∏–±—Ä–∏–¥–Ω—ã–π –∞—É–¥–∏—Ç UPDATE –∏ DELETE](#7-–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è-–∑–∞–¥–∞—á–∞-–≥–∏–±—Ä–∏–¥–Ω—ã–π-–∞—É–¥–∏—Ç-update-–∏-delete)
* [8. –ó–∞–¥–∞—á–∏ –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è](#8-–∑–∞–¥–∞—á–∏-–¥–ª—è-—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

---

## 1. –ó–∞—á–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSONB –¥–ª—è –∞—É–¥–∏—Ç–∞

–ü—Ä–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º –∞—É–¥–∏—Ç–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤—Ä–æ–¥–µ `users_history`, `orders_history` –∏ —Ç.–¥.
–ù–æ –∫–æ–≥–¥–∞ —Ç–∞–±–ª–∏—Ü —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–µ—Å—è—Ç–∫–∏, —ç—Ç–æ –Ω–µ—É–¥–æ–±–Ω–æ.

JSONB –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å **—Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω–æ–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ**:

* ‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü.
* ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å ‚Äî –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–µ–∑ ALTER TABLE.
* ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ ‚Äî –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø–æ –∫–ª—é—á–∞–º JSON (`old_data->>'email'`).
* ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Äî JSON –ª–µ–≥–∫–æ —á–∏—Ç–∞—Ç—å –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã.

---

## 2. –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ JSONB –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –æ–±—ã—á–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏—Å—Ç–æ—Ä–∏–∏

| –ö—Ä–∏—Ç–µ—Ä–∏–π         | –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏          | JSONB-–∞—É–¥–∏—Ç                              |
| ---------------- | ------------------------ | ---------------------------------------- |
| –ì–∏–±–∫–æ—Å—Ç—å —Å—Ö–µ–º—ã   | –ñ—ë—Å—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞        | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è                             |
| –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å    | –ù—É–∂–Ω–æ ALTER TABLE        | –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–ª—é—á–∏ –≤ JSON             |
| –°–∫–æ—Ä–æ—Å—Ç—å –≤—Å—Ç–∞–≤–∫–∏ | –í—ã—Å–æ–∫–∞—è                  | –ß—É—Ç—å –Ω–∏–∂–µ, –Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è                 |
| –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å       | –•–æ—Ä–æ—à–∞—è, –Ω–æ —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω–∞—è | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç                   |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è       | –õ–æ–∫–∞–ª—å–Ω–∞—è                | –õ–µ–≥–∫–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Kafka, ELK, ClickHouse |

---

## 3. –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∞—É–¥–∏—Ç–∞

–°–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É `audit_log`, –≤ –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ–º –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ JSONB-—Ñ–æ—Ä–º–∞—Ç–µ.

```sql
CREATE TABLE audit_log (
    id SERIAL PRIMARY KEY,
    table_name TEXT,
    operation TEXT,
    old_data JSONB,
    new_data JSONB,
    changed_at TIMESTAMP DEFAULT NOW(),
    user_name TEXT,
    app_name TEXT
);
```

üß© **–ü–æ—è—Å–Ω–µ–Ω–∏–µ:**

* `old_data` ‚Äî –¥–∞–Ω–Ω—ã–µ –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è;
* `new_data` ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ;
* `operation` ‚Äî `INSERT`, `UPDATE` –∏–ª–∏ `DELETE`;
* `app_name` –∏ `user_name` —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.

---

## 4. –§—É–Ω–∫—Ü–∏—è-—Ç—Ä–∏–≥–≥–µ—Ä audit_changes() ‚Äî –±–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è

```sql
CREATE OR REPLACE FUNCTION audit_changes()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_log (table_name, operation, old_data, new_data, user_name, app_name)
    VALUES (
        TG_TABLE_NAME,
        TG_OP,
        to_jsonb(OLD),
        to_jsonb(NEW),
        current_user,
        current_setting('application_name', true)
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**–ü—Ä–∏–≤—è–∑–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:**

```sql
CREATE TRIGGER audit_users
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW
EXECUTE FUNCTION audit_changes();
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```sql
INSERT INTO users (username, email) VALUES ('ivan', 'ivan@mail.ru');
UPDATE users SET email = 'ivan_new@mail.ru' WHERE username = 'ivan';
DELETE FROM users WHERE username = 'ivan';

SELECT table_name, operation, old_data, new_data, user_name, app_name FROM audit_log;
```

üü¢ –í —Ç–∞–±–ª–∏—Ü–µ `audit_log` –ø–æ—è–≤—è—Ç—Å—è —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.

---

## 5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤—Ä–µ–º—è

PostgreSQL –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –ª–æ–≥ —Ç–æ—á–Ω–µ–µ:

| –§—É–Ω–∫—Ü–∏—è                                     | –û–ø–∏—Å–∞–Ω–∏–µ                                            |
| ------------------------------------------- | --------------------------------------------------- |
| `current_user`                              | –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—ã–ø–æ–ª–Ω—è—é—â–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏—é             |
| `session_user`                              | –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏                     |
| `current_setting('application_name', true)` | –∏–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, DBeaver, Python, Airflow) |
| `clock_timestamp()`                         | —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è                             |

–ü—Ä–∏–º–µ—Ä —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º:

```sql
CREATE OR REPLACE FUNCTION audit_changes_verbose()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_log (table_name, operation, old_data, new_data, user_name, app_name, changed_at)
    VALUES (
        TG_TABLE_NAME,
        TG_OP,
        to_jsonb(OLD),
        to_jsonb(NEW),
        current_user,
        current_setting('application_name', true),
        clock_timestamp()
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

–¢–µ–ø–µ—Ä—å –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏.

---

## 6. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –≤–µ—Ä—Å–∏—è ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª–µ–π

–ò–Ω–æ–≥–¥–∞ –ø–æ–ª–Ω—ã–π JSON –∏–∑–±—ã—Ç–æ—á–µ–Ω.
–ú–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å **—Ç–æ–ª—å–∫–æ —Ç–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å**.

```sql
CREATE OR REPLACE FUNCTION audit_differences()
RETURNS TRIGGER AS $$
DECLARE
    diffs JSONB;
BEGIN
    -- –≤—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É NEW –∏ OLD
    diffs := (
        SELECT jsonb_object_agg(key, value)
        FROM jsonb_each(to_jsonb(NEW))
        WHERE (to_jsonb(OLD)->key) IS DISTINCT FROM value
    );

    IF diffs IS NOT NULL AND diffs <> '{}'::jsonb THEN
        INSERT INTO audit_log (table_name, operation, new_data, user_name)
        VALUES (TG_TABLE_NAME, TG_OP, diffs, current_user);
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**–ü—Ä–∏–≤—è–∑–∫–∞:**

```sql
CREATE TRIGGER audit_users_diffs
AFTER UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION audit_differences();
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```sql
UPDATE users SET email = 'new_email@mail.ru', username = 'alex' WHERE id = 1;
SELECT new_data FROM audit_log ORDER BY id DESC LIMIT 1;
```

üü¢ –†–µ–∑—É–ª—å—Ç–∞—Ç:

```json
{"email": "new_email@mail.ru", "username": "alex"}
```

---

## 7. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞: –≥–∏–±—Ä–∏–¥–Ω—ã–π –∞—É–¥–∏—Ç UPDATE –∏ DELETE

**–ó–∞–¥–∞—á–∞:**
–°–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ª–æ–≥–∏—Ä—É–µ—Ç:

* –¥–ª—è `UPDATE` ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –ø–æ–ª—è (`diffs`);
* –¥–ª—è `DELETE` ‚Äî –ø–æ–ª–Ω—ã–µ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (`OLD`).

**–†–µ—à–µ–Ω–∏–µ:**

```sql
CREATE OR REPLACE FUNCTION audit_update_delete()
RETURNS TRIGGER AS $$
DECLARE
    diffs JSONB;
BEGIN
    IF TG_OP = 'UPDATE' THEN
        diffs := (
            SELECT jsonb_object_agg(key, value)
            FROM jsonb_each(to_jsonb(NEW))
            WHERE (to_jsonb(OLD)->key) IS DISTINCT FROM value
        );

        IF diffs IS NOT NULL AND diffs <> '{}'::jsonb THEN
            INSERT INTO audit_log (table_name, operation, new_data, user_name)
            VALUES (TG_TABLE_NAME, 'UPDATE', diffs, current_user);
        END IF;

    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO audit_log (table_name, operation, old_data, user_name)
        VALUES (TG_TABLE_NAME, 'DELETE', to_jsonb(OLD), current_user);
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**–ü—Ä–∏–≤—è–∑–∫–∞:**

```sql
CREATE TRIGGER audit_users_adv
AFTER UPDATE OR DELETE ON users
FOR EACH ROW
EXECUTE FUNCTION audit_update_delete();
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**

```sql
UPDATE users SET email = 'delta@mail.ru' WHERE id = 1;
DELETE FROM users WHERE id = 1;

SELECT operation, old_data, new_data FROM audit_log ORDER BY id DESC LIMIT 2;
```

---

## 8. –ó–∞–¥–∞—á–∏ –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### üß© –£—Ä–æ–≤–µ–Ω—å 1

–°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É `products` –∏ –¥–æ–±–∞–≤—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä `audit_changes()`.
–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ `INSERT`, `UPDATE`, `DELETE` –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `audit_log`.

---

### üß© –£—Ä–æ–≤–µ–Ω—å 2

–ò–∑–º–µ–Ω–∏ —Ñ—É–Ω–∫—Ü–∏—é `audit_differences()` —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∞ –∑–∞–ø–∏—Å—ã–≤–∞–ª–∞ —Ç–∞–∫–∂–µ `changed_at` –∏ `app_name`.

---

### üß© –£—Ä–æ–≤–µ–Ω—å 3

–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é `audit_user_actions()`, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≥–¥–µ –∏–∑–º–µ–Ω–∏–ª—Å—è email, –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ JSON –ø–æ–ª–µ `"changed_field": "email"`.

---

### üß© –£—Ä–æ–≤–µ–Ω—å 4

–†–µ–∞–ª–∏–∑—É–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä `audit_all_tables`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –ø–æ–≤–µ—Å–∏—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü (users, employees, orders).
–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–π `TG_TABLE_NAME` –∏ `TG_OP` ‚Äî –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è.

---

‚úÖ –ü–æ—Å–ª–µ —ç—Ç–æ–π –≥–ª–∞–≤—ã —Ç—ã —É–º–µ–µ—à—å:

* —Å—Ç—Ä–æ–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞ —á–µ—Ä–µ–∑ JSONB;
* –≤—ã—á–∏—Å–ª—è—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É OLD –∏ NEW;
* –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –ø–æ–ª—è;
* —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è;
* –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –æ–¥–Ω–æ–º —Ç—Ä–∏–≥–≥–µ—Ä–µ.

---

üìò –°–ª–µ–¥—É—é—â–∏–π —Ñ–∞–π–ª ‚Üí [05_practice_and_selfcheck.md](05_practice_and_selfcheck.md)
**‚Äú–ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞, —Ä–∞–∑–±–æ—Ä —Ä–µ—à–µ–Ω–∏–π –∏ —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞‚Äù**

